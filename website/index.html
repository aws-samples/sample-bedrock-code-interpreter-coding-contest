<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code Interpreter Coding Contest</title>
    <link rel="stylesheet" href="common.css">
    <script src="config.js"></script>
    <script src="components.js"></script>
</head>
<body>
    <div class="container">
        <app-header></app-header>
        <app-nav current="home"></app-nav>
        
        <div class="content">
            <div class="api-examples">
                <h2>提出API仕様</h2>
                <p>エンドポイントURL: <span id="api-endpoint"></span></p>
                <script>
                    document.getElementById('api-endpoint').textContent = 
                        (window.API_CONFIG?.url || 'デプロイ後に表示されます') + 'submit';
                </script>
                <div class="code-block">
                    <div class="code-container">
                        <pre><code id="api-example">openapi: 3.0.0
info:
  title: Coding Contest API
  version: 1.0.0
paths:
  /submit:
    post:
      summary: コード提出
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - username
                - problem_number
                - code
              properties:
                username:
                  type: string
                  example: "your_username"
                problem_number:
                  type: integer
                  example: 1
                code:
                  type: string
                  example: "def solver(s):\\n    return \\"result\\""
      responses:
        '200':
          description: 提出結果
          content:
            application/json:
              schema:
                type: object
                properties:
                  result:
                    type: string
                    enum: [correct, incorrect]
                  message:
                    type: string</code></pre>
                        <button onclick="copyCode('api-example')" class="copy-btn">コピー</button>
                    </div>
                </div>
            </div>

            <div class="leaderboard">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                    <h2>リーダーボード</h2>
                    <div>
                        <span>ゲーム状態: </span>
                        <span id="gameStatus" style="padding: 4px 8px; border-radius: 4px; font-weight: bold;">読み込み中...</span>
                    </div>
                </div>
                <div id="leaderboard-content">読み込み中...</div>
            </div>
        </div>
    </div>

    <script>
        const API_URL = window.API_CONFIG?.url || 'http://localhost:3000';

        function copyCode(elementId) {
            const codeElement = document.getElementById(elementId);
            const text = codeElement.textContent;
            navigator.clipboard.writeText(text).then(() => {
                const btn = codeElement.parentElement.querySelector('.copy-btn');
                const originalText = btn.textContent;
                btn.textContent = '✅ コピー済み';
                setTimeout(() => {
                    btn.textContent = originalText;
                }, 2000);
            });
        }

        async function loadGameStatus() {
            try {
                const response = await fetch(`${API_URL}/game-state`);
                const data = await response.json();
                const statusElement = document.getElementById('gameStatus');
                
                if (data.is_active) {
                    statusElement.textContent = '進行中';
                    statusElement.style.backgroundColor = '#28a745';
                } else {
                    statusElement.textContent = '終了';
                    statusElement.style.backgroundColor = '#dc3545';
                }
                statusElement.style.color = 'white';
            } catch (error) {
                const statusElement = document.getElementById('gameStatus');
                statusElement.textContent = '進行中';
                statusElement.style.backgroundColor = '#28a745';
                statusElement.style.color = 'white';
            }
        }

        let problemCount = 0;

        async function loadProblems() {
            try {
                const response = await fetch('problems.json');
                const problems = await response.json();
                problemCount = Object.keys(problems).length;
            } catch (error) {
                problemCount = 4;
            }
        }

        async function loadLeaderboard() {
            try {
                const response = await fetch(`${API_URL}/leaderboard`);
                const data = await response.json();
                const container = document.getElementById('leaderboard-content');
                container.textContent = '';
                
                if (data.length === 0) {
                    const div = document.createElement('div');
                    div.style.cssText = 'text-align: center; padding: 40px; color: #666;';
                    div.textContent = 'まだ提出がありません';
                    const br = document.createElement('br');
                    div.appendChild(br);
                    div.appendChild(document.createTextNode('最初の挑戦者になりましょう！'));
                    container.appendChild(div);
                    return;
                }
                
                const table = document.createElement('table');
                const headerRow = document.createElement('tr');
                const headers = ['順位', 'ユーザー名'];
                for (let i = 1; i <= problemCount; i++) {
                    headers.push(`問題${i}`);
                }
                headers.forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    headerRow.appendChild(th);
                });
                table.appendChild(headerRow);
                
                data.forEach((entry, index) => {
                    const row = document.createElement('tr');
                    const td1 = document.createElement('td');
                    td1.textContent = index + 1;
                    row.appendChild(td1);
                    const td2 = document.createElement('td');
                    td2.textContent = entry.username;
                    row.appendChild(td2);
                    for (let i = 1; i <= problemCount; i++) {
                        const td = document.createElement('td');
                        td.textContent = entry[`problem${i}_time`] || '-';
                        row.appendChild(td);
                    }
                    table.appendChild(row);
                });
                
                container.appendChild(table);
            } catch (error) {
                document.getElementById('leaderboard-content').textContent = 'リーダーボードの読み込みに失敗しました';
            }
        }

        // 初期化
        loadProblems().then(() => {
            loadGameStatus();
            loadLeaderboard();
        });
        
        // 5秒ごとに更新
        setInterval(() => {
            loadGameStatus();
            loadLeaderboard();
        }, 5000);
    </script>
</body>
</html>